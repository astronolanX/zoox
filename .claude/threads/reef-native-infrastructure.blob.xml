<blob type="thread" scope="project" status="active" updated="2026-01-15" v="3">
  <summary>Reef as Native AI Infrastructure - Design Thread + Agent SDK Plan</summary>
  <files>
    <file>docs/plans/2026-01-15-reef-native-infrastructure-design.md</file>
    <file>docs/plans/2026-01-15-agent-sdk-implementation-plan.md</file>
    <file>docs/plans/2026-01-15-plan-validation.md</file>
    <file>src/reef/calcification.py</file>
    <file>src/reef/skills/loader.py</file>
    <file>src/reef/agents/</file>
    <file>src/reef/workers/</file>
    <file>src/reef/mcp/</file>
    <file>src/reef/safety/</file>
  </files>
  <decisions>
    <decision why="Spark challenged explicit structure; Karen validated hybrid">Graph relationships: content-embedded intent + computed similarity (no separate links.xml)</decision>
    <decision why="Team consensus: different concerns, proven pattern">Reef and config coexist with clear authority boundaries</decision>
    <decision why="Visionary insight: organic/authored is temporal">Promotion pathway: organic → crystallized → human-promoted to config</decision>
    <decision why="Karen: bidirectional sync is a tar pit">Reef reads config, cannot modify it; human remains gatekeeper</decision>
    <decision why="Architect: content-as-truth eliminates sync">Links stored in polip content via [[wiki]] and @directives</decision>
    <decision why="7-agent team validation: safety-first before automation">P0 safety guards (dry-run, deletion limits, undo) must ship before any auto-pruning</decision>
    <decision why="Market research: MCP is now standard protocol">Implement reef MCP server exposing polip operations as tools</decision>
    <decision why="Cost optimization: free workers for grunt work">Route external-ok tasks to Groq/Ollama/Gemini, reserve Claude for judgment</decision>
    <decision why="Academic validation: A-MEM proves self-organizing works">Calcification engine with time × usage × consensus triggers</decision>
    <decision why="Developer sentiment: transparency + control required">Audit trail, dry-run mode, and validator checks for all automatic operations</decision>
    <decision why="Parallel development needs isolation">Worktree harness: spawn child Claude agents in git worktrees, test before merge</decision>
  </decisions>
  <next>
    <step status="done">Phase 0: Create directory structure for agent SDK</step>
    <step status="done">Phase 1: Implement P0 safety guards (dry-run, deletion limits, undo buffer)</step>
    <step status="done">Phase 2: Worker infrastructure (Groq/Ollama/Gemini dispatch)</step>
    <step status="done">Phase 3: MCP server implementation</step>
    <step status="done">Phase 4: Agent orchestrator, strategist, validator</step>
    <step status="done">Phase 5: Skill hotloading (global + project-local)</step>
    <step status="done">Phase 6: Calcification engine + adversarial decay</step>
    <step status="pending">Phase 7: Worktree harness - parallel Claude agents with test-before-merge</step>
    <step status="pending">Phase 8: Integration polish + documentation</step>
  </next>
  <spec-phase-7>
## Phase 7: Worktree Harness - Parallel Claude Development

Enable multiple Claude agents to work on isolated features simultaneously, each in its own git worktree with independent testing before upstream merge.

### Architecture
```
Main worktree (orchestrator)
├── git worktree create reef-phase7-feature-x
│   └── Claude session A (feature-x implementation)
│       └── Tests run locally before signaling merge
├── git worktree create reef-phase7-feature-y
│   └── Claude session B (feature-y implementation)
│       └── Tests run locally before signaling merge
└── Orchestrator merges when both report green
```

### Components
1. **TrenchHarness** (src/reef/trench.py)
   - `spawn(branch_name)` → create worktree + return path
   - `status()` → check all active child sessions
   - `merge(branch_name)` → run tests in worktree, merge if green

2. **ChildSession Protocol**
   - Each child logs progress to `.reef-child-session.log`
   - Child runs tests before signaling ready
   - Parent orchestrator reads status file, merges on success

3. **CLI Commands**
   - `reef trench spawn <feature>` → Launch child Claude
   - `reef trench status` → See all active branches
   - `reef trench merge <feature>` → Merge if tests pass
   - `reef trench abort <feature>` → Kill child, clean worktree

### Test Protocol
- Child session runs `uv run pytest` in isolated worktree
- All 501+ tests must pass locally before merge
- Parent verifies test log, performs merge
- On failure, child session persists for debugging

### Child Context
Each spawned Claude inherits:
- Full reef codebase in worktree
- `.claude/` polips (scoped to project + session)
- This thread as context (resume capability)
- Instructions to test before signaling ready

### Success Criteria
✓ Spawn 2+ parallel child worktrees without conflicts
✓ Each runs independent tests (no shared state pollution)
✓ Orchestrator merges successfully when both report green
✓ Resume next session: child can continue work, parent can continue orchestration
  </spec-phase-7>
  <related>
    <ref>constraints-project-rules</ref>
  </related>
  <context>
## Session Summary (2026-01-15)

Deep brainstorming session exploring reef as native AI infrastructure. Key insight: reef enables AI to grow its own databases organically, rather than conforming to human-designed schemas.

### Research Phase (D)
- Surveyed AI infrastructure landscape (EverMemOS, MCP, Apple Intelligence vs Copilot)
- Found: "Memory is becoming the state layer for agentic systems"
- Key paper: "Everything is Context" - file system as universal semantic interface

### Biology Phase (A)
- Defined polip lifecycle: spawn → drift → attach → grow → bud → calcify
- Calcification triggers: Time × Usage × Ceremony × Consensus × Genome (combinatorial)
- Death/decay: staleness→fossil, supersession→absorbed, contradiction→skeleton
- Reef geology: active → skeletal → fossil → sediment layers

### Portability Phase (C)
- Start at L0 (plain files), calcify toward L3/L4
- Content embedding: lifecycle-based (drifting=ref, calcified=embed)
- Activation layers: SDK → middleware → daemon

### Gap Analysis (B)
- 5 gaps identified; build order: relationships → evolution → sovereignty → provenance → protocol
- Gap 4 resolved: hybrid graph (content-embedded links + computed similarity)

### Coexistence Resolution
- Config = instructions TO AI (human domain, override authority)
- Reef = memory OF AI (AI domain, advisory authority)
- Promotion pathway from organic → crystallized → human-committed

### Paradigm Crystallized
Traditional: Human architect → Schema design → Data conforms
Reef: AI usage → Polips spawn → Structure emerges → Calcification creates schema

The schema isn't designed — it's grown.

## Session 2: Agent SDK Deep Dive (2026-01-15 afternoon)

### Team Research (7 Agents)
Spawned 7 agents in parallel to validate organic schema growth:
- **Researcher**: Found AutoSchemaKG (92% alignment), A-MEM (NeurIPS 2025)
- **ML Theorist**: Resolved probability vs structure tension (they're complementary)
- **Signal Analyst**: Framework for inflection point detection
- **Systems Architect**: Stigmergic coordination vision
- **Devil's Advocate**: Identified safety gaps (pruning, sync, emergent behavior)
- **Competitive Intel**: Reef's coral metaphor is unique differentiator
- **Technical Validator**: P0 safeguards are critical path

### Comprehensive Implementation Plan
Created 7-phase plan at `docs/plans/2026-01-15-agent-sdk-implementation-plan.md`

## Session 3: Phase 5-6 Implementation (2026-01-15 evening)

### Completed
- **Phase 5**: Skill hotloading with SkillLoader, SkillRegistry
  - Discovery from local (.claude/skills/) and global (~/.claude/skills/)
  - Hotload tracking via mtime, reload callbacks
  - CLI: `reef skills list/show/create/check`
  - Fixed test isolation bug (property descriptor vs evaluated value)

- **Phase 6**: Calcification engine (the core thesis)
  - `CalcificationEngine`: Time × Usage × Ceremony × Consensus scoring
  - `AdversarialDecay`: Challenge stale/orphan polips (SURVIVE/MERGE/DECOMPOSE)
  - `ReefHealth`: Vitality scoring, lifecycle stages, recommendations
  - CLI: `reef health`, `reef calcify`, `reef decay`
  - Added `related` field to index for consensus scoring

### Worker Trench Test
- Attempted parallel worker dispatch (Groq + Ollama)
- Groq: 403 Forbidden (API key issue)
- Ollama: Worked but output too generic without reef context
- Insight: Domain-specific code needs full context; workers better for grunt tasks

### New Phase Added
- **Phase 7**: Worktree harness for parallel Claude agents
  - Each child session works in isolated git worktree
  - Tests must pass before merging upstream
  - Enables true parallel development without conflicts

## To Resume
1. Surface this thread: `/surface threads-reef-native-infrastructure`
2. Next: Phase 7 - Worktree harness implementation
3. Phase 7 components:
   - `reef trench spawn <branch>` - create worktree + launch Claude
   - `reef trench status` - check child session progress
   - `reef trench merge <branch>` - run tests + merge if green
4. Then Phase 8: Integration polish
  </context>
</blob>
